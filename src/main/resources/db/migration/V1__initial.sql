-- Enable UUID extension if needed (optional)
-- CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- =====================================================
-- 1. Helper Functions & Triggers (Postgres specific)
-- =====================================================

-- Function to handle 'ON UPDATE CURRENT_TIMESTAMP' behavior
CREATE OR REPLACE FUNCTION update_modified_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
RETURN NEW;
END;
$$ language 'plpgsql';

-- =====================================================
-- 2. Tables
-- =====================================================

-- Main Survey Form Table
CREATE TABLE survey_forms (
                              id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                              group_type VARCHAR(20) NOT NULL DEFAULT 'GROUP_B',
                              name VARCHAR(100) NOT NULL,
                              student_id VARCHAR(100) NOT NULL UNIQUE,
                              age INTEGER NOT NULL,
                              ethical_considerations TEXT, -- Replaces level_of_study
                              academic_year_semester VARCHAR(20) NOT NULL,
                              location VARCHAR(20) NOT NULL,
                              devices_others_specify VARCHAR(200),
                              internet_access VARCHAR(10) NOT NULL,
                              hours_online VARCHAR(20) NOT NULL,
                              familiar_with_ai VARCHAR(10) NOT NULL,
                              use_ai_tools VARCHAR(10) NOT NULL,
                              ai_usage_frequency VARCHAR(20) NOT NULL,
                              learned_about_ai TEXT NOT NULL,

    -- Audit Fields
                              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
                              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
                              submitted_by_ip VARCHAR(45),
                              is_completed BOOLEAN DEFAULT FALSE NOT NULL
);

-- Trigger for updated_at
CREATE TRIGGER update_survey_forms_modtime
    BEFORE UPDATE ON survey_forms
    FOR EACH ROW EXECUTE PROCEDURE update_modified_column();

-- Admin User Table (Mapped in User.java)
CREATE TABLE admin_user (
                            id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                            username VARCHAR(255) NOT NULL UNIQUE,
                            password VARCHAR(255) NOT NULL,
                            role VARCHAR(255) DEFAULT 'USER'
);

-- Collection Tables
CREATE TABLE survey_devices (
                                id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                survey_id BIGINT NOT NULL REFERENCES survey_forms(id) ON DELETE CASCADE,
                                device VARCHAR(100) NOT NULL
);

CREATE INDEX idx_survey_devices_survey ON survey_devices(survey_id);

CREATE TABLE survey_study_tools (
                                    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                    survey_id BIGINT NOT NULL REFERENCES survey_forms(id) ON DELETE CASCADE,
                                    tool VARCHAR(100) NOT NULL
);

CREATE TABLE survey_writing_tools (
                                      id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                      survey_id BIGINT NOT NULL REFERENCES survey_forms(id) ON DELETE CASCADE,
                                      tool VARCHAR(100) NOT NULL
);

CREATE TABLE survey_note_tools (
                                   id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                   survey_id BIGINT NOT NULL REFERENCES survey_forms(id) ON DELETE CASCADE,
                                   tool VARCHAR(100) NOT NULL
);

CREATE TABLE survey_research_tools (
                                       id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                       survey_id BIGINT NOT NULL REFERENCES survey_forms(id) ON DELETE CASCADE,
                                       tool VARCHAR(100) NOT NULL
);

CREATE TABLE survey_presentation_tools (
                                           id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                           survey_id BIGINT NOT NULL REFERENCES survey_forms(id) ON DELETE CASCADE,
                                           tool VARCHAR(100) NOT NULL
);

-- CT Skill Table
CREATE TABLE ct_skill (
                          id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                          code VARCHAR(50) NOT NULL UNIQUE,
                          name VARCHAR(100) NOT NULL
);

-- CT Question Table
CREATE TABLE ct_question (
                             id VARCHAR(50) NOT NULL PRIMARY KEY,
                             section CHAR(1) NOT NULL,
                             number VARCHAR(10) NOT NULL,
                             title VARCHAR(255),
                             text TEXT NOT NULL,
                             rubric TEXT NOT NULL,
                             max_score INTEGER NOT NULL,
                             active BOOLEAN DEFAULT TRUE NOT NULL,
                             created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
                             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

CREATE TRIGGER update_ct_question_modtime
    BEFORE UPDATE ON ct_question
    FOR EACH ROW EXECUTE PROCEDURE update_modified_column();

-- CT Question Skill Mapping
CREATE TABLE ct_question_skill (
                                   question_id VARCHAR(50) NOT NULL REFERENCES ct_question(id) ON DELETE CASCADE,
                                   skill_id INTEGER NOT NULL REFERENCES ct_skill(id) ON DELETE CASCADE,
                                   PRIMARY KEY (question_id, skill_id)
);

-- CT Evaluation Table
CREATE TABLE ct_evaluation (
                               id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                               survey_id BIGINT NOT NULL REFERENCES survey_forms(id) ON DELETE CASCADE,
                               question_id VARCHAR(50) NOT NULL REFERENCES ct_question(id) ON DELETE RESTRICT,
                               student_answer TEXT NOT NULL,
                               score INTEGER,
                               on_topic BOOLEAN,
                               skills_json JSONB, -- Using Postgres JSONB for better performance
                               reason TEXT,
                               strength TEXT,
                               weakness TEXT,
                               eval_model VARCHAR(100),
                               created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

-- =====================================================
-- 3. Views
-- =====================================================

CREATE OR REPLACE VIEW v_survey_stats_by_location AS
SELECT
    location,
    COUNT(*) as total_surveys,
    SUM(CASE WHEN use_ai_tools = 'Yes' THEN 1 ELSE 0 END) as ai_users,
    SUM(CASE WHEN internet_access = 'Yes' THEN 1 ELSE 0 END) as with_internet,
    ROUND(AVG(age), 2) as avg_age
FROM survey_forms
WHERE is_completed = TRUE
GROUP BY location;

CREATE OR REPLACE VIEW v_ai_usage_frequency_dist AS
SELECT
    ai_usage_frequency,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / NULLIF((SELECT COUNT(*) FROM survey_forms WHERE is_completed = TRUE), 0), 2) as percentage
FROM survey_forms
WHERE is_completed = TRUE
GROUP BY ai_usage_frequency;

-- =====================================================
-- 4. Initial Data Seed (Skills & Questions)
-- =====================================================

INSERT INTO ct_skill (code, name) VALUES
                                      ('INTERPRETATION',  'Interpretation'),
                                      ('ANALYSIS',        'Analysis'),
                                      ('EVALUATION',      'Evaluation'),
                                      ('INFERENCE',       'Inference'),
                                      ('EXPLANATION',     'Explanation'),
                                      ('SELF_REGULATION', 'Self-regulation');

-- SECTION A
INSERT INTO ct_question (id, section, number, title, text, rubric, max_score) VALUES
                                                                                  ('CTA-AI-01.A1', 'A', 'A1', 'Core problem summary',
                                                                                   'In your own words, summarise the core problem presented in the case in no more than 120 words. Your summary should clearly show: a) The role of AI in students’ academic performance, and b) The concern about students’ critical thinking.',
                                                                                   'Marking guideline (0–5): 0 = Off topic or blank. 1–2 = Mentions AI and grades, but misses the paradox. 3–4 = Captures both grade improvement and CT concern. 5 = Concise, accurate summary showing tension between performance and critical thinking.', 5),
                                                                                  ('CTA-AI-01.A2', 'A', 'A2', 'Peripheral higher education',
                                                                                   'Explain what is meant by “peripheral higher education” in this context. How might “peripherality” shape both the adoption and the impact of AI tools in the sociology classroom?',
                                                                                   'Marking guideline (0–5): 0 = No attempt. 1–2 = Vague. 3–4 = Shows understanding of peripherality. 5 = Clearly connects peripherality to AI adoption and impact.', 5);

-- SECTION B
INSERT INTO ct_question (id, section, number, title, text, rubric, max_score) VALUES
                                                                                  ('CTA-AI-01.B1', 'B', 'B1', 'Implicit assumptions about “smart learning”',
                                                                                   'Identify three implicit assumptions made by university management when they interpret higher grades as evidence of “smart learning” success. For each assumption, explain why it may be problematic from a sociological perspective.',
                                                                                   'Marking guideline (0–6): 0–1 = Not assumptions. 2–3 = 1–2 assumptions. 4–5 = 3 plausible assumptions. 6 = Three clearly-stated assumptions, each critically explained.', 6),
                                                                                  ('CTA-AI-01.B2', 'B', 'B2', 'AI, democratisation and “luxury” of CT',
                                                                                   'A colleague argues: “AI is democratizing knowledge... Critical thinking is a luxury; our students first need high marks...” a) Reconstruct this argument. b) Critically analyse strengths and weaknesses using two sociological concepts.',
                                                                                   'Marking guideline (0–7): 0–2 = Superficial. 3–4 = Partial reconstruction. 5–6 = Clear structure and balanced evaluation. 7 = Accurate reconstruction + nuanced critique.', 7),
                                                                                  ('CTA-AI-01.B3', 'B', 'B3', 'Evidence vs opinion in the case',
                                                                                   'From the case, list three pieces of evidence and three opinions. Explain how confusing evidence with opinion can mislead decision-making.',
                                                                                   'Marking guideline (0–7): 0–2 = Random lists. 3–4 = Some distinction. 5–6 = Correctly identifies items. 7 = Clear classification with strong explanation.', 7);

-- SECTION C
INSERT INTO ct_question (id, section, number, title, text, rubric, max_score) VALUES
                                                                                  ('CTA-AI-01.C1', 'C', 'C1', 'Inferences from AI–performance–CT pattern',
                                                                                   'Based on Table 1, what inferences can you reasonably draw about the relationship between AI use, academic performance, and critical thinking? Identify two interpretations and one alternative explanation.',
                                                                                   'Marking guideline (0–10): 0–3 = Descriptive. 4–6 = Plausible but simple cause-effect. 7–8 = Multiple interpretations. 9–10 = Sophisticated reasoning balancing AI effect with structural explanations.', 10),
                                                                                  ('CTA-AI-01.C2', 'C', 'C2', 'Study design: AI and CT in sociology',
                                                                                   'Design a small empirical study to test whether AI use diminishes critical thinking. Outline: RQ, hypothesis, variables, design, and one ethical concern.',
                                                                                   'Marking guideline (0–10): 0–3 = Vague. 4–6 = Sensible but limited. 7–8 = Clear hypothesis, variables, confounders. 9–10 = Awareness of bias and fairness.', 10);

-- SECTION D
INSERT INTO ct_question (id, section, number, title, text, rubric, max_score) VALUES
                                                                                  ('CTA-AI-01.D1', 'D', 'D1', 'Your own learning and AI',
                                                                                   'Do you think your own learning would benefit more from: a) Limited/no AI use, or b) Guided/critical use? Justify in 120–150 words using one sociological theory.',
                                                                                   'Marking guideline (0–5): 0–1 = Pure opinion. 2–3 = Some justification. 4 = Clear position with concept. 5 = Strongly reasoned and theoretically grounded.', 5),
                                                                                  ('CTA-AI-01.D2', 'D', 'D2', 'Meta-reflection on AI use during test',
                                                                                   '(For AI-using group): Describe how you used AI during this test. Evaluate where it helped and where it weakened your thinking.',
                                                                                   'Marking guideline (0–5): 0–1 = Superficial. 2–3 = Identifies aspects but shallow. 4 = Concrete examples. 5 = Deeply reflective comparison.', 5);

-- Map Questions to Skills (Assuming IDs 1-6 match insertion order)
INSERT INTO ct_question_skill (question_id, skill_id) VALUES
                                                          ('CTA-AI-01.A1', 1), -- Interpretation
                                                          ('CTA-AI-01.A2', 1), ('CTA-AI-01.A2', 2), -- Interpretation, Analysis
                                                          ('CTA-AI-01.B1', 2), ('CTA-AI-01.B1', 3), ('CTA-AI-01.B1', 1), -- Analysis, Evaluation, Interpretation
                                                          ('CTA-AI-01.B2', 2), ('CTA-AI-01.B2', 3), ('CTA-AI-01.B2', 1),
                                                          ('CTA-AI-01.B3', 1), ('CTA-AI-01.B3', 3), ('CTA-AI-01.B3', 4), -- Interpretation, Evaluation, Inference
                                                          ('CTA-AI-01.C1', 4), ('CTA-AI-01.C1', 2), ('CTA-AI-01.C1', 3), -- Inference, Analysis, Evaluation
                                                          ('CTA-AI-01.C2', 4), ('CTA-AI-01.C2', 5), ('CTA-AI-01.C2', 6), -- Inference, Explanation, Self-regulation
                                                          ('CTA-AI-01.D1', 5), ('CTA-AI-01.D1', 3), ('CTA-AI-01.D1', 6), -- Explanation, Evaluation, Self-regulation
                                                          ('CTA-AI-01.D2', 6), ('CTA-AI-01.D2', 3); -- Self-regulation, Evaluation